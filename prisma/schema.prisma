generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum TenantType {
  CLUB
  BUSINESS
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum TenantPlan {
  BASIC
  PRO
  ENTERPRISE
}

// Business Model Segregation
enum BusinessModel {
  CLUB_SOCIOS // Enfocado en membres√≠as y cuotas mensuales
  COMERCIAL // Enfocado en tr√°fico y consumo directo
}

// Member Categories for VIP Tier System
enum MemberCategory {
  GENERAL // Cliente sin descuento
  VIP // Cliente recurrente, no paga cuota pero tiene descuento
  SOCIO // Cliente con membres√≠a activa y cuota al d√≠a
}

enum MaintenanceType {
  PREVENTIVO
  CORRECTIVO
}

enum MaintenanceCategory {
  PANO
  ELECTRICO
  ESTRUCTURA
}

model Tenant {
  id              String       @id @default(cuid())
  name            String
  slug            String       @unique
  type            TenantType   @default(BUSINESS)
  status          TenantStatus @default(ACTIVE)
  plan            TenantPlan   @default(PRO)
  subscriptionEnd DateTime?

  primaryColor   String  @default("#1a4d2e")
  secondaryColor String  @default("#ffffff")
  backgroundColor String @default("#ffffff")
  logoUrl        String?
  baseRate       Float   @default(100.0) // Tarifa por minuto por defecto

  // Localization & Taxes
  currencyCode   String @default("CLP") // ISO 4217: USD, EUR, MXN
  currencySymbol String @default("$")
  locale         String @default("es-CL") // Formatting: 1.000 vs 1,000
  timezone       String @default("America/Santiago") // IANA Timezone

  taxRate     Float  @default(0.19)  // Decimal: 0.19 = 19% IVA
  taxName     String @default("IVA") // Etiqueta: IVA, IGV, sales tax
  isTaxExempt Boolean @default(false) // true = exento, 0% sin alerta Sentinel

  // üìù Legal & Billing Info (SII Connect)
  rutEmisor           String? // Formato: 12345678-5
  razonSocial         String?
  giro                String?
  direccionTributaria String?
  folioRanges         FolioRange[] // Autonumeraci√≥n por tipo (33, 39, etc.)

  // Business Model & Tier Settings
  businessModel BusinessModel @default(COMERCIAL)
  tierSettings  Json? // VIP thresholds, discounts, etc

  settings  Json?
  uiConfig  Json? // Parametrizaci√≥n avanzada del Frontend Vanguard
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  members         Member[]
  tables          Table[]
  usageLogs       UsageLog[]
  products        Product[]
  dailyBalances   DailyBalance[]
  serviceRequests ServiceRequest[]
  paymentRecords  PaymentRecord[]
  systemLogs      SystemLog[]
  maintenanceLogs MaintenanceLog[] @relation("TenantMaintenance")
  stockMovements  StockMovement[]
  // generatedReports GeneratedReport[] // TEMP: Disabled pending schema validator fix
}

// Lead Management - Sales Funnel
enum LeadStatus {
  NEW
  CONTACTED
  DEMO_SCHEDULED
  CONVERTED
  ARCHIVED
}

// === Suscripciones Club (H√≠bridas) ===
enum SubscriptionStatus {
  ACTIVE
  IN_ARREARS
  CANCELLED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}


// Landing Page - Lead Capture
model Lead {
  id               String     @id @default(cuid())
  name             String
  email            String     @unique
  country          String
  phone            String?
  message          String?
  detectedCurrency String? // Moneda detectada por IP
  status           LeadStatus @default(NEW) // Sales funnel tracking
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([email])
  @@index([createdAt])
  @@index([status])
  @@index([country])
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  password  String?
  role      String   @default("USER")
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Member {
  id       String  @id @default(cuid())
  name     String
  email    String?
  phone    String?
  rut      String? // Configurable ID
  discount Float   @default(0.0) // Percentage (0-100) - Legacy field

  // VIP Tier System
  category          MemberCategory @default(GENERAL)
  
  // üéüÔ∏è Suscripciones H√≠bridas (Club)
  subscriptionStatus SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd   DateTime?
  membershipPlanId   String?
  membershipPlan     MembershipPlan? @relation(fields: [membershipPlanId], references: [id])
  payments           MembershipPayment[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  usageLogs   UsageLog[]
  tierChanges TierChange[] // Audit trail

  lockerNumber      String?
  handicap          Float?   @default(0.0)

  amountSpent Float @default(0.0) // Metric for "Best Customer"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([category])
  @@index([subscriptionStatus])
}


model Table {
  id               String           @id @default(cuid())
  number           Int
  status           String           @default("available")
  tenantId         String
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lastSessionStart DateTime?
  currentSessionId String?
  usageLogs        UsageLog[]
  serviceRequests  ServiceRequest[] // QR Notifications

  totalPlayHours       Float             @default(0.0)
  maintenanceThreshold Float             @default(100.0)
  lastMaintenanceAt    DateTime?
  maintenanceLogs      MaintenanceLog[] @relation("TableMaintenance")

  @@unique([number, tenantId])
  @@index([tenantId])
}

model MembershipPlan {
  id           String       @id @default(cuid())
  name         String
  price        Float
  isTaxable    Boolean      @default(true) // true: 19% IVA, false: Exento (DTE 41)
  billingCycle BillingCycle @default(MONTHLY)
  
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  members      Member[]
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([tenantId])
}

model MembershipPayment {
  id           String   @id @default(cuid())
  amount       Float
  taxAmount    Float    @default(0.0) // 0 si el plan es isTaxable=false
  dteType      Int      @default(39)  // 39=Boleta, 41=Boleta Honorarios/Exenta
  
  // SII Connect Info
  folioDTE     Int?
  dteStatus    String?
  urlCertificado String?

  // üí≥ Webhook & Payment Gateway
  transactionId String?  @unique // ID en Webpay/Stripe (Payment Intent)
  status        String   @default("PENDING") // PENDING, PAID, FAILED

  memberId     String
  member       Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([memberId])
  @@index([tenantId])
}

model MaintenanceLog {
  id         String              @id @default(cuid())
  type       MaintenanceType
  category   MaintenanceCategory
  cost       Float               @default(0.0)
  technician String
  notes      String?

  tableId  String
  targetTable    Table  @relation("TableMaintenance", fields: [tableId], references: [id], onDelete: Cascade)

  tenantId String
  logTenant   Tenant @relation("TenantMaintenance", fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tableId])
}

model FolioRange {
  id           String @id @default(cuid())
  tenantId     String
  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tipoDTE      Int    // SII Tipo Documento: 33 (Factura), 39 (Boleta), 61 (Nota Cr√©dito)
  startFolio   Int
  endFolio     Int
  currentFolio Int    @default(0) // El √∫ltimo folio consumido
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, tipoDTE])
}

model UsageLog {
  id              String    @id @default(cuid())
  tableId         String
  table           Table     @relation(fields: [tableId], references: [id], onDelete: Cascade)
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  startedAt       DateTime
  endedAt         DateTime?
  durationMinutes Int?
  amountCharged   Float     @default(0.0) // Final Total (con impuesto incluido)

  // üßæ Tax Breakdown (por sesi√≥n)
  taxAmount Float   @default(0.0) // Monto del impuesto incluido en amountCharged
  taxRate   Float   @default(0.0) // Tasa aplicada (e.g. 0.19)
  taxName   String  @default("IVA") // Etiqueta del impuesto

  // üìÑ Destino DTE (SII Connect)
  tipoDTE             Int?    // 39 (Boleta) o 33 (Factura)
  rutReceptor         String? // 12345678-5
  razonSocialReceptor String?
  giroReceptor        String?
  folioDTE            Int?    // N√∫mero de folio oficial asignado
  dteStatus           String? // PENDING, GENERATED, SENT, FAILED
  urlCertificado      String? // Link al PDF o QR validador

  discountApplied Float   @default(0.0) // Amount saved
  memberId        String?
  member          Member? @relation(fields: [memberId], references: [id])

  paymentStatus  String          @default("PENDING") // PENDING, PAID
  paymentRecords PaymentRecord[]

  items     OrderItem[]
  createdAt DateTime    @default(now())

  dailyBalanceId String?
  dailyBalance   DailyBalance? @relation(fields: [dailyBalanceId], references: [id])

  @@index([tenantId])
  @@index([tableId])
  @@index([dailyBalanceId])
  @@index([memberId])
  // Optimizations
  @@index([tenantId, startedAt]) // Reports filtering by date
  @@index([tenantId, paymentStatus]) // Finance dashboard (Pending payments)
  @@index([tenantId, endedAt]) // Active sessions lookup
}

model PaymentRecord {
  id            String  @id @default(cuid())
  amount        Float
  method        String // CASH, CARD, TRANSFER
  status        String // COMPLETED, FAILED, PENDING
  provider      String // STRIPE, WEBPAY, CASHy
  transactionId String? // External ID

  usageLogId String
  usageLog   UsageLog? @relation(fields: [usageLogId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // üîê Webhook Security
  idempotencyKey String? @unique // Prevenir procesamiento duplicado
  webhookData    Json? // Payload completo del webhook para auditor√≠a

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([usageLogId])
  @@index([tenantId, createdAt]) // Optimization for Bank Reconciliation
  @@index([idempotencyKey]) // Webhook idempotency lookup
}

model DailyBalance {
  id             String   @id @default(cuid())
  date           DateTime @default(now())

  // === 1. Revenue Streams ===
  totalRevenue      Float @default(0.0) // Suma de todos los streams
  timeRevenue       Float @default(0.0) // Tax√≠metro (tiempo de juego)
  productRevenue    Float @default(0.0) // Bar / Cocina
  membershipRevenue Float @default(0.0) // Cuotas sociales (modelo Club)
  rentalRevenue     Float @default(0.0) // Arriendos (Lockers, canchas extra)

  // === 2. Payment Reconciliation ===
  cashRevenue   Float @default(0.0) // Efectivo te√≥rico del sistema
  cardRevenue   Float @default(0.0) // Tarjeta / Digital
  creditRevenue Float @default(0.0) // Cuentas corrientes / Cr√©dito socio

  // === 3. Bottom Line (Costos y P√©rdidas) ===
  totalCost       Float @default(0.0) // COGS: Costo de insumos vendidos
  wasteCost       Float @default(0.0) // Valor de mermas registradas en el turno
  maintenanceCost Float @default(0.0) // Gastos de mantenimiento del turno
  netProfit       Float @default(0.0) // Utilidad Neta = Ingresos - (COGS + Mermas + Mantenimiento)

  // === 4. Blind Cash Audit (Sentinel) ===
  cashInHand     Float?  // Efectivo contado manualmente por el cajero
  cashDifference Float?  // +Sobra / -Falta
  hasCashAlert   Boolean @default(false) // üö© Bandera Roja Sentinel

  // === Meta ===
  closedBy String
  notes    String?
  status   String  @default("CLOSED") // OPEN, CLOSED

  usageLogs UsageLog[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([date])
  @@index([tenantId, date]) // Filtro de reportes por periodo
}


model Product {
  id        String   @id @default(cuid())
  name      String
  sku       String?  // C√≥digo √∫nico de inventario
  price     Float    // Precio de venta
  costPrice Float    @default(0.0) // Precio de compra (costo)
  stock     Int      @default(0)
  minStock  Int      @default(0) // Umbral para alertas
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems      OrderItem[]
  stockMovements  StockMovement[]
  recipes         Recipe[]        @relation("ParentProduct")
  usedInRecipes   Recipe[]        @relation("IngredientProduct")

  @@index([tenantId])
  @@index([sku])
}

model StockMovement {
  id        String   @id @default(cuid())
  quantity  Int
  type      String   // ENTRADA, SALIDA, VENTA, MERMA, AJUSTE
  reason    String?
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId    String?  // ID del responsable del movimiento
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([productId])
}

model Recipe {
  id              String  @id @default(cuid())
  parentId        String  // El producto compuesto (ej. "Mojito")
  parent          Product @relation("ParentProduct", fields: [parentId], references: [id], onDelete: Cascade)
  
  ingredientId    String  // El insumo base (ej. "Ron")
  ingredient      Product @relation("IngredientProduct", fields: [ingredientId], references: [id], onDelete: Cascade)
  
  quantity        Float   // Cantidad proporcional del ingrediente

  @@index([parentId])
  @@index([ingredientId])
}

model OrderItem {
  id         String @id @default(cuid())
  quantity   Int
  unitPrice  Float // Precio al momento de la venta (snapshot)
  totalPrice Float // quantity * unitPrice

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict) // No borrar producto si tiene ventas

  usageLogId String
  usageLog   UsageLog @relation(fields: [usageLogId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([usageLogId])
  @@index([productId])
}

enum RequestType {
  CALL
  ORDER
}

enum RequestStatus {
  PENDING
  ATTENDED
  COMPLETED
}

model ServiceRequest {
  id      String        @id @default(cuid())
  type    RequestType   @default(CALL)
  status  RequestStatus @default(PENDING)
  message String?

  tableId String
  table   Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tableId])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String // INFO, WARN, ERROR, CRITICAL
  message   String
  details   Json?
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([level])
  @@index([tenantId])
  @@index([createdAt])
}

model TierChange {
  id           String         @id @default(cuid())
  memberId     String
  member       Member         @relation(fields: [memberId], references: [id], onDelete: Cascade)
  fromCategory MemberCategory
  toCategory   MemberCategory
  reason       String
  changedBy    String
  tenantId     String
  createdAt    DateTime       @default(now())

  @@index([memberId])
  @@index([tenantId])
  @@index([createdAt])
}

// TEMP BYPASS: GeneratedReport model disabled pending Prisma 7.4 validator fix
// Re-enable by uncommenting this block and the generatedReports relation in Tenant
// model GeneratedReport {
//   id          String   @id @default(cuid())
//   tenantId    String
//   tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
//   reportType  String
//   period      String
//   metricsSnapshot Json
//   generatedAt DateTime @default(now())
//   sentTo      String?
//   sentAt      DateTime?
//   deliveryStatus String @default("PENDING")
//   downloadToken String? @unique
//   tokenExpiry   DateTime?
//   @@index([tenantId])
//   @@index([period])
//   @@index([downloadToken])
//   @@index([deliveryStatus])
// }
